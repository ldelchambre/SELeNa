/**
 * @file nsieg_test.c
 *
 * Non-singular isothermal ellipsoid in presence of an external shear lens model, test file.
 *
 * Copyright 2018 Ludovic Delchambre <ldelchambre@uliege.be>
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
 * MA 02110-1301, USA.
 */
#include <math.h>
#include <nsieg.h>
#include <stdio.h>

#define THETAS_TOL 1e-6 // Gravlens image positions have a precision of 1e-6
#define MU_TOL 5e-5     // Amplification is no extremely precise in gravlens (uses numerical derivatives?)

/**
 * NSIEg lens model parameters as defined in Keeton, C. R., "Software for
 * Gravitational Lensing", 2004, http://www.physics.rutgers.edu/~keeton/gravlens/manual.pdf.
 *
 * These corresponds to gravlens code is:
 * > maingrid 1 -2.5 2.5 100 -2.5 2.5 100
 * > setlens 1 1
 * > alpha bp 0 0 e theta_e gamma theta_gamma sp 0 1
 * > 0 0 0 0 0 0 0 0 0 0
 * > findimg theta_s[0] theta_s[1]
 */
struct keeton_parameters {
  const double bp;          // p[1] : Normalized scaled factor
  const double e;           // p[4] : Ellipticity (]0, 1])
  const double theta_e;     // p[5] : Orientation of the system [rad]
  const double gamma;       // p[6] : Shear intensity
  const double theta_gamma; // p[7] : Shear orientation [rad]
  const double sp;          // p[8] : Normalized core radius
  const double theta[2];    // Image position in cartesian coordinates (from gravlens code)
  const double mu;          // Image amplification (from gravlens)
  const double theta_s[2];  // Source position in cartesian coordinates
} keeton[] = {
  // Simplest case, no shear, no orientation
  {1.0, 0.5, 0.0, 0.0, 0, 0.1,
    {1.093612e+00, 6.924236e-01}, 2.825198e+00, {0.1, 0.3}},
  // No shear but non-null orientation
  {2.0, 0.7, 62.*M_PI/180, 0.0, 0.0, 0.3,
    {1.753848e+00, 2.377386e+00}, 1.862541e+00, {0.4, 0.2}},
  // No orientation but some shear
  {0.5, 0.8, 0.0, 0.5, 112.*M_PI/180, 0.2,
    {-3.384418e-01, 1.279657e+00},  3.354902e+00, {0.3, 0.4}},
  // Shear + orientation
  {1.5, 0.4, 121.*M_PI/180, 0.17, 34.*M_PI/180, 0.4,
    {1.263050e+00, 8.588202e-01}, 1.381680e+01, {0.2, 0.1}},
  // Lot of random configurations
  {1.566150814997434, 0.8326740597782322, 5.5560864447833014, 0.7040379752407446, 0.2859481952335572, 0.1889865075411521, {4.165381e-01, 1.585254e+00}, -1.187054e+00, {0.2513518845448886, 0.639216638975911}},
  {1.692101428345213, 0.03695084949726928, 2.3624426227117370, 0.9530387614051335, 0.4847559712184095, 0.5142089162762568, {-6.043336e-01, 2.442256e-01}, -9.822114e-01, {0.2934574469392402, 0.5312617346120737}},
  {1.311193434711553, 0.053898111604243, 3.9442808386617734, 0.3079391580327236, 2.2966184958436751, 0.4476793708888318, {1.704170e+00, -8.740431e-01}, 2.555124e+00, {0.5770378975516005, 0.1376341286939683}},
  {1.922952305841839, 0.4125608590553371, 1.0844909769948881, 0.4405279089325957, 1.4382030299079283, 0.8945752562999195, {3.417595e-02, -1.821801e+00}, 4.876552e+00, {0.4574697978800605, 0.2735391921326809}},
  {1.538173304387533, 0.5756004097668482, 4.1553389455250542, 0.4947351549161176, 1.0100603366116556, 0.05146383027687189, {9.312107e-01, -8.476632e-01}, -4.846373e-01, {0.6143264543437689, 0.03547298542134796}},
  {1.847366536351843, 0.5138306615353798, 2.5630906742272113, 0.0551665687886173, 3.3184794790596830, 0.593819264887544, {-1.211308e+00, 1.536188e+00}, 2.802388e+00, {0.004138168359411098, 0.4974983054739499}},
  {1.11230500478441, 0.3907063840103467, 2.0109755573165327, 0.6468263101312622, 1.7803404084933745, 0.005537213231073412, {8.573564e-01, 2.509128e-01}, -4.733490e-01, {0.3925232598778405, 0.0953697103944378}},
  {1.722270407969503, 0.04007099662063777, 1.8149024402691576, 0.4862628657108288, 5.4502795473335013, 0.2353849747653153, {1.140275e+00, 1.211102e+00}, -1.882361e+00, {0.7722137282564691, 0.6071921130825444}},
  {1.971923941548756, 0.4322983821373771, 4.7511258276581181, 0.8707214754999533, 3.6733315786820286, 0.5359442268534458, {-1.113312e+00, -8.606340e-01}, -4.982247e+00, {0.8696178263152221, 0.6947373752244667}},
  {1.341475782565698, 0.8199412655537723, 2.4706754975670839, 0.02363546650945729, 4.8655518124231065, 0.08368651444842927, {-5.347473e-01, 2.163490e+00}, 2.015140e+00, {0.7034809010717498, 0.4245621754017012}},
  {1.857621377530325, 0.6522598541934908, 1.1575269017062773, 0.9828176685790936, 1.0955458168297136, 0.3689855901910454, {-1.313596e-01, -6.075823e-02}, -4.130806e-01, {0.1106117489128991, 0.387967135084678}},
  {1.077015238507195, 0.5055752857311382, 2.9229240213231336, 0.9377562861643851, 1.3551602670618754, 0.6154171635985798, {9.352160e-02, -7.207172e-02}, -2.434150e+00, {0.08682900617067295, 0.007576378385733151}},
  {1.12836339620985, 0.8572507953215691, 3.6296948044213391, 0.79149764097751, 0.3309488395817725, 0.5855351476560439, {-1.010575e-01, -6.149478e-03}, -4.610140e-01, {0.1057531961162018, 0.1024883529441956}},
  {1.05687015921141, 0.1594736110436625, 3.2537897449187665, 0.8649948826732661, 2.3801561147342927, 0.7400820301163242, {5.703783e-02, 7.942477e-01}, -1.834296e+00, {0.696142430966068, 0.4456781747951664}},
  {1.978716815969225, 0.249713190071524, 1.8118826418920115, 0.9283285670606175, 0.8144382598522404, 0.5785928378564934, {-7.076209e-01, -2.751664e-01}, -1.721730e+00, {0.323138702071836, 0.7493560327023635}},
  {1.671272353716828, 0.6437304242098231, 3.2292733095973292, 0.7286953421483947, 3.4278839498911067, 0.3696741768676992, {-1.134680e-02, -7.401955e-03}, -6.518179e-01, {0.03753064536582333, 0.003577034368215037}},
  {1.828335556512752, 0.9476174555504365, 1.3769453370728864, 0.2915367855219552, 0.7022538145488398, 0.4025430896261804, {7.112939e-01, -4.412689e-01}, -5.644371e-01, {0.8470754944227906, 0.4466753071416302}},
  {1.269830730723249, 0.759643869739792, 1.0358307363541863, 0.7637161367609525, 4.5000777094279520, 0.4649149451200899, {-1.422994e-02, -1.665565e-01}, -5.175516e-01, {0.1585222440945219, 0.2476489298703647}},
  {1.329453206832455, 0.06474486034569198, 6.2721289292249303, 0.1427840637541271, 5.8725822151462834, 0.7258027376402336, {1.693355e+00, 5.129342e-01}, 2.501051e+00, {0.7120708143989686, 0.4912262198732422}},
  {1.316461204535624, 0.2253118612700534, 4.2880097507709722, 0.2640034665712206, 3.9142819698020346, 0.5702697519373051, {1.579610e+00, 1.216238e+00}, 2.093294e+00, {0.4799163261965004, 0.1118787371333008}},
  {1.104356937271258, 0.3728997450847431, 0.1563333742127216, 0.9609153750023973, 0.3300052307581743, 0.2101953264970014, {-4.234417e-01, 2.696869e-01}, -7.183059e-01, {0.4587649960802775, 0.4363600989412152}},
  {1.324409530044476, 0.1659478639500896, 0.7328275570471852, 0.2383679993323649, 1.8108968556434941, 0.8705907488530623, {1.424860e-01, 2.419453e+00}, 1.884300e+00, {0.3135181102909783, 0.9939739778811048}},
  {1.065633900061214, 0.9169876888199151, 2.9208901811182790, 0.9898422248770502, 4.1827598173392264, 0.8120085912736239, {-5.206518e-01, -6.387594e-01}, -4.054575e+00, {0.2006996056893313, 0.1000704429494742}},
  {1.289991980838528, 0.2825963248344637, 3.7935635637288447, 0.9381858003279528, 5.6196693073812218, 0.4592516410361847, {3.322478e-01, 1.062369e+00}, -1.053286e+00, {0.8489017991305181, 0.7821341853797542}},
  {1.288940179540484, 0.5204134103317882, 1.9996723636868687, 0.9023532768349004, 1.2525755697444318, 0.106971684685003, {6.615894e-01, -5.015893e-01}, -6.378618e-01, {0.5113549302627627, 0.4951668720204919}},
  {1.73931973600422, 0.05960400139059045, 2.9895967477412819, 0.7732570593797863, 2.6452826517264234, 0.5820116234659563, {3.935054e-01, 4.511063e-01}, -1.083862e+00, {0.02649320894161971, 0.3608985851290502}},
  {1.305509586749605, 0.7362754578423666, 0.4750427979903362, 0.5739696344523465, 1.4943319580604104, 0.4696669316177882, {-3.659843e-01, -2.280270e+00}, 3.312377e+00, {0.4221969360615768, 0.08993350689872197}},
  {1.760282134491962, 0.3558835067840345, 4.5208184494238459, 0.1835225023828004, 4.3131077776051310, 0.3121764789835134, {1.063240e+00, 2.214202e+00}, 2.080448e+00, {0.271568214799724, 0.2007851335241284}},
  {1.663982922336463, 0.3217765768303226, 1.2874468413498528, 0.1201171305238942, 4.0736501358530637, 0.6988391190617314, {1.418701e+00, 1.866643e+00}, 2.067077e+00, {0.538031938902649, 0.4933880258049864}},
  {1.139157177015578, 0.1772065282519237, 0.8675181306714147, 0.8134660876255205, 0.1284170161571339, 0.5419793460754589, {-2.128693e+00, -2.545549e-01}, 8.510048e+00, {0.4785638442474229, 0.1594638248981797}},
  {1.043801275103755, 0.2635659500096455, 0.8308921937512739, 0.4370603050749884, 3.0992629740869959, 0.7173382675810993, {1.159550e+00, 8.083725e-01}, 3.131000e+00, {0.1338931715179345, 0.7769566721033989}},
  {1.991939157209461, 0.1454024873163528, 2.7187590387374225, 0.8716273336263227, 0.9995635879465772, 0.2092496815756481, {-8.410905e-01, 2.940236e-01}, -4.806918e-01, {0.1603245279459731, 0.2992583697256283}},
  {1.156061660451303, 0.9615495597006583, 3.6354315654928389, 0.7232697644644912, 0.4141721452947091, 0.346192032140274, {-2.289736e-01, -3.926169e-01}, -4.522982e-01, {0.929722272161143, 0.02051493566450584}},
  {1.150856202644121, 0.2124967262821638, 5.7871258365726979, 0.243827152576947, 0.7467691186418141, 0.8328921515075204, {1.753035e+00, 1.302899e+00}, 1.893342e+00, {0.7511218019354777, 0.4958651898270686}},
  {1.915165523596273, 0.2464929665100941, 3.7527200760622326, 0.1053989910121554, 4.8339627453233218, 0.2177641864984208, {-2.946257e-01, -8.304543e-01}, -3.500484e+00, {0.3185333900752214, 0.6517407819634896}},
  {1.661360445674832, 0.07242057485030644, 6.0066645212873384, 0.3289876009934863, 0.4541093029971109, 0.4793859946949271, {2.093484e+00, 9.460006e-01}, 2.436630e+00, {0.173479520783241, 0.07184719581775061}},
  {1.692537764468368, 0.02077483648037031, 3.0669678639546185, 0.97052610007506, 2.9472856325835584, 0.6880717097570567, {-2.752772e-01, 8.364992e-01}, -9.005855e-01, {0.5416558717599165, 0.7082764621389228}},
  {1.883053944725834, 0.8100344580828954, 0.6725081333667273, 0.206378310536442, 6.1389324227224060, 0.2468074003857377, {-6.751201e-01, 9.098449e-01}, -6.277977e-01, {0.01788929812526345, 0.1467477253351746}},
  {1.411876988545737, 0.102463250817147, 3.4100635599324560, 0.06071294786873831, 1.6495253822510001, 0.8730869902461054, {2.482421e-01, 1.386821e+00}, 3.239688e+00, {0.1111239246294366, 0.5536589272562945}},
  {1.850507987313457, 0.2079595722638747, 3.8336177622936796, 0.08118443848218009, 5.1644781149582011, 0.4283296769066481, {1.414798e+00, 2.148048e+00}, 2.630665e+00, {0.6586153744408418, 0.8010984225682578}},
  {1.345194341434894, 0.4931932974863901, 3.9607545661119743, 0.817728806405987, 2.5070016925316443, 0.3337186882347939, {-1.843805e-01, 1.591502e+00}, -2.412776e+00, {0.9325153650843023, 0.6741161288229903}},
  {1.955327545103241, 0.09944456183083465, 4.6751135526974945, 0.7284166414070016, 4.5761725588110558, 0.01724462708799861, {1.149548e+00, -1.026385e+00}, -8.793535e-01, {0.7614996973519111, 0.8050428316291973}},
  {1.602909689570051, 0.2978286316161101, 1.2220220861649189, 0.6571895998894194, 6.1232741157588118, 0.1766011882652819, {-4.407365e-01, 1.075235e+00}, -1.192908e+00, {0.4233239573047817, 0.2777771487559279}},
  {1.982165863339433, 0.978938413999086, 3.1829319602569424, 0.006414096824020765, 5.8756087673991448, 0.4161242655304654, {-1.964382e-01, 7.536500e-01}, -3.610617e-01, {0.5434467924515085, 0.711919821664071}},
  {1.415583435772939, 0.9728424301895432, 3.0252111001717501, 0.6912324493206911, 0.4069481011904716, 0.7023626783051429, {-1.986300e-01, 2.251921e-01}, -5.493488e-01, {0.2028412572032884, 0.3720136853060395}},
  {1.87205859860203, 0.7730981256508569, 4.6131254893240365, 0.3069016307223772, 0.4980157726825427, 0.3586786447943239, {-1.333165e+00, -1.787587e+00}, 2.620338e+00, {0.05866689981646105, 0.4910487467209415}},
  {1.728835870594339, 0.1495295944191463, 3.2893732134647831, 0.9047418355842191, 1.3211829714508365, 0.3791412679118014, {5.947516e-01, -4.888571e-01}, -7.220897e-01, {0.401710923044495, 0.2647212094434718}},
  {1.262141043451906, 0.007943476488240609, 0.0377115923533039, 0.6404688843445651, 2.2820412478466969, 0.05805916878108312, {8.988380e-01, 1.082163e+00}, -1.288141e+00, {0.8930970980646872, 0.6196980039345322}},
  {1.762781509399812, 0.1899329233039924, 5.1804030281609847, 0.7916401123833591, 1.2231719997204573, 0.2876861863407579, {7.184792e-01, -3.425053e-01}, -6.174769e-01, {0.236595674450308, 0.1375128202980819}},
  {1.538896960515797, 0.5971909202720915, 5.1817052241144763, 0.09698124794873079, 1.3262584172180403, 0.9863004084089586, {6.997361e-01, 1.183136e+00}, 4.955882e+00, {0.6110526511171753, 0.2790747650142922}},
  {1.208132506360797, 0.2287002872172286, 5.1810685019511604, 0.1155761780571134, 5.7666573955281262, 0.4440157570424532, {1.511895e+00, -2.288297e-01}, 2.946421e+00, {0.5272693776790731, 0.1336933631900319}},
  {1.467170547648701, 0.2987919367533661, 5.4490449748290484, 0.7409489720432401, 5.8328741872939949, 0.6845685113231466, {6.776132e-01, 3.844860e-01}, -1.353750e+00, {0.05445027701463771, 0.7081357031188108}},
  {1.992548881151715, 0.4147028524445099, 4.5660343571763393, 0.9517833414277673, 0.8258419514560532, 0.5217507034613699, {-6.995468e-01, -2.584986e-01}, -1.183753e+00, {0.3054512577898116, 0.9643962155935876}},
  {1.97101145160075, 0.03475132724695322, 4.0070766653167516, 0.3653867335077878, 1.5584190730386489, 0.3289016152647884, {1.197731e+00, -2.212529e+00}, 3.867805e+00, {0.8491824694323227, 0.1062393216235959}},
  {1.765015163668198, 0.1796305449544409, 1.2599953731974829, 0.7379355628681182, 2.9812016068374243, 0.2149364046263404, {-8.587911e-02, 1.105849e+00}, -7.499984e-01, {0.2730285745085392, 0.3526724831826152}},
  {1.062280138123001, 0.6989032579418807, 2.3206717456133035, 0.4788197061766796, 0.9840856308892916, 0.9513287701135, {6.721308e-01, 1.295753e+00}, 3.676957e+00, {0.2347442234373757, 0.2895684654481503}},
  {1.575391247631936, 0.7154624301571405, 5.7471523269767353, 0.1501155867171755, 6.0863562218272556, 0.7057305955452615, {2.021172e+00, -1.452693e-01}, 2.143821e+00, {0.2962268991198097, 0.4819387899160687}},
  {1.702129370919107, 0.01523482862635022, 1.1473879665459246, 0.2241732682578396, 5.5576484539918729, 0.5123055461369054, {2.302945e+00, -9.878853e-01}, 2.369588e+00, {0.7485634543450869, 0.04390716880367622}},
  {1.613560242807686, 0.2598610972904895, 5.2452220133335841, 0.9350466567491706, 3.2636275844908185, 0.096140773003402, {-5.944671e-01, 1.128787e+00}, -6.484569e-01, {0.4475951382505155, 0.8793176330204615}},
  {1.290892116204182, 0.3649737713709845, 4.6712318530052777, 0.3267733999955858, 1.2560737309282339, 0.8269774671024881, {1.202913e+00, 2.298602e+00}, 1.780867e+00, {0.714780614706741, 0.4882602067697288}},
  {1.168135733759558, 0.4523384837463514, 3.8777710287618139, 0.9517185413321632, 0.1995876985792683, 0.0009367811285684758, {-2.891987e-01, -6.686834e-01}, -5.764839e-01, {0.8887411558135698, 0.001111781057757044}},
  {1.95532103964314, 0.8457515506539434, 4.5554804809943432, 0.4226384481001117, 4.2515711569961931, 0.407219824231523, {-2.290264e-01, -2.454714e-01}, -5.961784e-01, {0.06580122586833852, 0.8734595276206283}},
  {1.863143777391459, 0.918793146388773, 4.8447896057357296, 0.1868657260929249, 2.8305281982372108, 0.4460953542574118, {2.315231e+00, -1.706088e+00}, 2.228881e+00, {0.9748063204417661, 0.9515646264758797}},
  {1.392047723005071, 0.7850709865045307, 1.5149583272509033, 0.7679156531404714, 1.9649693351370401, 0.1220777693957846, {6.008123e-01, 2.978508e-02}, -2.227120e-01, {0.1096618138544171, 0.03352499069558317}},
  {1.890291028366182, 0.8027999147424483, 3.7053638508560898, 0.8636267060541983, 3.3455461945683571, 0.735090011522752, {-5.044039e-01, 4.809677e-01}, -4.270215e-01, {0.1739778083780768, 0.9854023366457451}},
  {1.790502654234626, 0.9202725599455216, 3.5966201936355615, 0.443957486352596, 0.2427419193376081, 0.4544342480443862, {-4.570640e-01, 1.445890e-01}, -4.864117e-01, {0.7075047732267489, 0.6893476707729088}},
  {1.426236929708525, 0.2677526265866705, 4.0747802121489869, 0.1392153250474165, 4.8443768521732471, 0.2588219488859069, {1.446055e-01, 1.883475e+00}, 2.503191e+00, {0.007033913918979939, 0.3533575412863268}},
  {1.12963870021454, 0.04929277485290388, 4.3702228238794927, 0.9794847922639482, 4.5428356455095136, 0.6645623283195358, {3.028560e-01, -4.060130e-01}, -1.116866e+00, {0.4955467585581358, 0.1787451115233181}},
  {1.463380562186633, 0.8381709959487162, 1.6307642497235442, 0.04168475491445538, 5.1343175665613625, 0.1524656700136338, {4.386050e-01, -2.041886e+00}, 1.822957e+00, {0.1258547919043213, 0.3775873055457273}},
  {1.183906526638546, 0.0236377640865189, 1.1627702555522217, 0.6702288329416576, 1.9679478345086494, 0.1254827563325511, {1.525924e+00, -1.282938e+00}, 5.612323e+00, {0.7845801430964382, 0.7661477934319835}},
  {1.306674040720468, 0.7397415949280212, 4.7663379584633034, 0.4028578335910617, 3.5170408137939222, 0.1770024992382935, {1.892040e+00, 2.170167e+00}, 2.024465e+00, {0.1962759019970658, 0.6874449395056369}},
  {1.534479717469021, 0.8113141810428405, 3.2999816022777413, 0.352441723003023, 5.2943242008575897, 0.2601166815529216, {-9.008874e-01, 1.349538e+00}, 1.961236e+01, {0.8911933600834104, 0.3182123093099365}},
  {1.300264026840523, 0.8852623853053957, 1.7578028259677216, 0.06701022196223709, 3.1393730224502843, 0.5689495242527705, {-1.314841e-01, 1.536439e+00}, 2.005903e+00, {0.1413000975362292, 0.09450742510461445}},
  {1.3316462919003, 0.4700738523336358, 1.6001569923362597, 0.04803547890567421, 4.0441832127546355, 0.2631727492959292, {1.666061e+00, 2.069461e+00}, 1.787149e+00, {0.983363767090496, 0.7768841689026335}},
  {1.918050800375873, 0.2444687144076458, 4.0271048915846066, 0.9602664822594398, 5.3107951119760832, 0.7906613558864879, {8.282790e-01, 2.847021e-01}, -9.782639e-01, {0.5594935745047436, 0.5418761077791889}},
  {1.04378054733725, 0.1449015293063374, 2.6945805870141939, 0.7865165061169345, 1.4166141499653913, 0.1864098068284731, {3.377147e-01, -1.929907e+00}, 7.020377e+00, {0.8377160149863812, 0.3568894905821584}},
  {1.486464639450516, 0.4574507124533364, 3.0959741593551642, 0.008582949449516254, 0.5694987715231834, 0.5642503206033762, {1.842607e+00, 1.483822e+00}, 2.127416e+00, {0.6744435770231895, 0.9118022985469033}},
  {1.935581443425829, 0.8492349629617698, 1.5136626481970101, 0.8469742855736672, 2.0018338791008694, 0.2920582464987457, {1.105788e+00, 7.891590e-02}, -2.486917e-01, {0.9303250833087831, 0.1652888851904923}},
  {1.979373084815707, 0.1520255795628002, 3.0776155958867761, 0.2305536302815509, 1.2666497142634909, 0.2017890154191058, {1.794509e+00, 1.990502e+00}, 3.028541e+00, {0.5658495945967389, 0.08804816758130589}},
  {1.547180165602148, 0.2298651219351833, 2.1653995269821777, 0.8745816027315626, 3.4155960678491484, 0.01161217743655234, {-9.222229e-01, 6.134416e-01}, -8.361582e-01, {0.767569322562915, 0.5310270672857458}},
  {1.487892644159047, 0.07853997644112125, 2.7940249014141272, 0.1677916430373532, 5.3549500203513292, 0.6502335338781164, {-2.019181e-01, 1.846699e+00}, 2.942228e+00, {0.2278670449167854, 0.6930391292410761}},
  {1.6129567439292, 0.002577972362324199, 5.4370969106402098, 0.8123903413026218, 3.3662632659078553, 0.3892652331761662, {-3.247265e-01, 7.396032e-01}, -7.633706e-01, {0.06005931687587578, 0.4674094138907803}},
  {1.291925063927615, 0.3440234707152015, 4.0526847580343617, 0.4811284077690403, 3.6796538467113389, 0.9765040927385228, {1.911785e+00, 1.488663e+00}, 2.229375e+00, {0.1224780533615419, 0.3688718739374896}},
  {1.309436212131396, 0.5203904927353192, 1.7029666327269561, 0.8560344207509774, 2.3872928003820872, 0.4950782235533895, {5.978343e-01, 3.660006e-01}, -8.184031e-01, {0.4826877627857508, 0.4399309670186741}},
  {1.24564271528679, 0.5698106478278052, 0.6416092700478052, 0.7810739127321188, 4.6330838338634246, 0.2953876918982524, {4.163856e-01, -7.049648e-01}, -1.309621e+00, {0.538065154374642, 0.4426933471246072}},
  {1.482587024503096, 0.4111979220975764, 5.2354139618774775, 0.9024105261939421, 5.5751378947232793, 0.2819928498511117, {8.684746e-01, 4.839707e-01}, -4.865897e-01, {0.2992780180699007, 0.8449109113318842}},
  {1.086516966746398, 0.3245955318139594, 3.1151992808335169, 0.9710915771995672, 0.0478756104639294, 0.03815441817073699, {-3.442132e-01, 3.921056e-01}, -4.642264e-01, {0.7407409277410462, 0.1227840786768795}},
  {1.509251933137187, 0.08964811879676242, 0.1660171882371833, 0.6712590104258371, 0.2728543884607111, 0.1907607330713348, {-1.224500e-01, -6.803111e-01}, -7.138020e-01, {0.4129828178703446, 0.0801941285570104}},
  // End sentinel
  {0, 0, 0, 0, 0, 0, {0,0}, 0, {0,0}}
};

void print_keeton_parameters(FILE *out, const struct keeton_parameters *kp) {
  fprintf(out, "bp          = %g\n", kp->bp);
  fprintf(out, "e           = %g\n", kp->e);
  fprintf(out, "theta_e     = %g\n", kp->theta_e);
  fprintf(out, "gamma       = %g\n", kp->gamma);
  fprintf(out, "theta_gamma = %g\n", kp->theta_gamma);
  fprintf(out, "sp          = %g\n", kp->sp);
  fprintf(out, "theta       = (%g, %g)\n", kp->theta[0], kp->theta[1]);
  fprintf(out, "mu          = %g\n", kp->mu);
  fprintf(out, "theta_s     = (%g, %g)\n", kp->theta_s[0], kp->theta_s[1]);
}

int main(void) {
  unsigned int i = 0;
  double alpha[2];
  double theta_s[2];
  double mu;

  // While we have some configuration to test
  while(keeton[i].bp > 0) {
    // Compute the lens model parameters neeeded by nsieg_alpha and nsieg_mu based
    // on the parameters from Keeton's gravlens
    const double q = 1. - keeton[i].e;                // Compute the axis ratio
    const double n = q * sqrt( 2. / ( 1. + q * q ) ); // Compute the normalization factor
    const double b = keeton[i].bp / n;                // (see Keeton, 2004, eq. 3.26)
    const double s = keeton[i].sp / n;                // and compute b, s from bp, sp

    // Keeton considered that the system is oriented based on the semi-minor axis
    // of the ellipse (/!\ eq. 3.2 from keeton, 2004, is false), wheras we use the
    // inclination based on the semi-major axis
    const double theta_e = keeton[i].theta_e + 0.5 * M_PI;

    // Compute the deflection angle
    nsieg_alpha(alpha, keeton[i].theta, b, keeton[i].e, theta_e, keeton[i].gamma, keeton[i].theta_gamma, s);

    // Compute the amplification
    mu = nsieg_mu(keeton[i].theta, b, keeton[i].e, theta_e, keeton[i].gamma, keeton[i].theta_gamma, s);

    // Compute the source position
    theta_s[0] = keeton[i].theta[0] - alpha[0];
    theta_s[1] = keeton[i].theta[1] - alpha[1];

    // Check that the source position is correct
    if(fabs(theta_s[0] - keeton[i].theta_s[0]) > THETAS_TOL
       || fabs(theta_s[1] - keeton[i].theta_s[1]) > THETAS_TOL) {
      fprintf(stderr, "=== Wrong source position ===\n");
      print_keeton_parameters(stderr, &keeton[i]);
      fprintf(stderr, "Found source position: (%g, %g)\n", theta_s[0], theta_s[1]);
      fprintf(stderr, "Difference in source position: (%g, %g)\n", theta_s[0] - keeton[i].theta_s[0],
                                                                   theta_s[1] - keeton[i].theta_s[1]);
    }

    // Check that the amplification is correct
    if(fabs(mu - keeton[i].mu) > MU_TOL) {
      fprintf(stderr, "=== Wrong amplification ===\n");
      print_keeton_parameters(stderr, &keeton[i]);
      fprintf(stderr, "Found amplification: %g\n", mu);
      fprintf(stderr, "Difference in amplification: %g\n", mu - keeton[i].mu);
    }

    // Go to next configuration
    i++;
  }

  return 0;
}
